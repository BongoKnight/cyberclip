try:
    from userAction.actionInterface import actionInterface
except:
    from actionInterface import actionInterface

import jq
import re
import json
from pathlib import Path
from yaml.loader import SafeLoader
import requests

"""Search observables in Virus Total."""

DEFAULT_PARAMS = {
                "Relationships":{
                    "type":"tags",
                    "value":["contacted_urls","contacted_domains","contacted_ips","dropped_files","bundled_files","itw_urls","submissions","execution_parents"]
                    },
                "Analysis fields":{
                    "type":"json",
                    "value":[".data.attributes.last_analysis_stats.malicious",
                             ".data.attributes.tags",
                             ".data.attributes.first_submission_date",
                             ".data.attributes.creation_date",
                             ".data.attributes.reputation",
                             ".data.attributes.meaningful_name",
                             ".data.attributes.magic",
                             ".data.attributes.size",
                             ".data.attributes.jarm",
                             ".data.attributes.asn",
                             ".data.relationships.bundled_files.data[].id",
                             ".data.relationships.contacted_domains.data[].id",
                             ".data.relationships.contacted_ips.data[].id",
                             ".data.relationships.contacted_urls.data[].context_attributes.url",
                             ".data.relationships.dropped_files.data[].id",
                             ".data.relationships.submissions.data.attributes.country",
                             ".data.relationships.submissions.data.attributes.date"],
                    "scheme":r'{"data": {"id": "b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9", "type": "file", "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9"}, "attributes": {"authentihash": "df88840176f21d02f2584b4d37806decca0558fa3994cfe96b4be36642e20dff", "ssdeep": "24576:n7LpZrGn9TQvn7LpZrGn9TQvG7LpZrGn9TQvM7LpZrGn9TQvH7LpZrGn9TQv:nmn9TQPmn9TQemn9TQUmn9TQvmn9TQ", "filecondis": {"raw_md5": "aaa9a58377672611dcd405a27896a365", "dhash": "00303c1d1e0d0c20"}, "tags": ["detect-debug-environment", "idle", "peexe", "overlay"], "first_submission_date": 1741001933, "trid": [{"file_type": "Windows Control Panel Item (generic)", "probability": 46.6}, {"file_type": "Win32 Executable MS Visual C++ (generic)", "probability": 25.2}, {"file_type": "Win64 Executable (generic)", "probability": 8.5}, {"file_type": "Win32 Dynamic Link Library (generic)", "probability": 5.3}, {"file_type": "Win16 NE executable (generic)", "probability": 4.0}], "names": ["HMRC_Self_Assessment.", "SearchProtocolHost.exe", "b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9.exe", "HMRC_Self_Assessment"], "type_description": "Win32 EXE", "detectiteasy": {"filetype": "PE32", "values": [{"info": "EXE32", "version": "2017 v.15.5-6", "type": "Compiler", "name": "EP:Microsoft Visual C/C++"}, {"info": "C", "version": "19.26.28900", "type": "Compiler", "name": "Microsoft Visual C/C++"}, {"version": "14.26.28900", "type": "Linker", "name": "Microsoft Linker"}, {"version": "2019 version 16.6", "type": "Tool", "name": "Visual Studio"}]}, "vhash": "0160666d155d15756hzf3z7tz", "type_extension": "exe", "sha256": "b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9", "tlsh": "T150858D317A418D72EEE322F925AD717A613CE4A21F3140CB639013DDA9757D1AE34B8B", "crowdsourced_yara_results": [{"ruleset_id": "00cc803bdc", "ruleset_name": "malware", "rule_name": "MALWARE_Win_FakeCaptcha_Downloader", "match_date": 1741178646, "description": "Detects downloader executables dropped by fake captcha", "author": "ditekshen", "source": "https://github.com/ditekshen/detection"}, {"ruleset_id": "01a3969525", "ruleset_name": "emmenhtal_strings_hta_exe", "rule_name": "emmenhtal_strings_hta_exe", "match_date": 1741178646, "description": "Emmenhtal Loader string", "author": "Sekoia.io", "source": "https://github.com/SEKOIA-IO/Community"}], "creation_date": 1094531389, "magic": "PE32 executable (console) Intel 80386, for MS Windows", "last_analysis_date": 1741178639, "sha1": "5c90034a9eda4297f451d1cfaa01670794f6ca83", "popular_threat_classification": {"suggested_threat_label": "trojan.lumma/lummastealer", "popular_threat_name": [{"count": 8, "value": "lumma"}, {"count": 4, "value": "lummastealer"}, {"count": 2, "value": "pudcs"}], "popular_threat_category": [{"count": 17, "value": "trojan"}, {"count": 3, "value": "dropper"}]}, "md5": "60deb6a8466e859cf48e0e6255a43bba", "signature_info": {"description": "Microsoft Windows Search Protocol Host", "file version": "7.0.20348.617 (WinBuild.160101.0800)", "original name": "SearchProtocolHost.exe", "product": "Windows\u00ae Search", "internal name": "SearchProtocolHost.exe", "copyright": "\u00a9 Microsoft Corporation. All rights reserved."}, "first_seen_itw_date": 1741003732, "last_modification_date": 1741178865, "reputation": -58, "total_votes": {"harmless": 0, "malicious": 1}, "last_submission_date": 1741178639, "unique_sources": 3, "meaningful_name": "SearchProtocolHost.exe", "pe_info": {"timestamp": 1094531389, "imphash": "994f18cb9978574a2203372470f204bc", "machine_type": 332, "entry_point": 100640, "resource_details": [{"lang": "ENGLISH US", "chi2": 139931.16, "filetype": "unknown", "entropy": 2.557454824447632, "sha256": "9fcd72479bd9daa3b6972ac0575bc51b36d63277918cc4ea2c6fdc01ffefbf2e", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 56421.75, "filetype": "unknown", "entropy": 2.776761054992676, "sha256": "f14419ea7f396c61884f368f355ecece1f1bc176394e7a01fa4cf1b1f58aeed4", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 41533.75, "filetype": "unknown", "entropy": 2.685296058654785, "sha256": "534caf543c0fbfb3633aa2b271fac33464c1a172c4e03d6abaef2ad318bc0774", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 19059.68, "filetype": "unknown", "entropy": 3.0767414569854736, "sha256": "f61fad95c199f7d0bf3d56f33837ab55e1010d66993dffed626ff0bf772f5031", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 227355.56, "filetype": "unknown", "entropy": 4.648410320281982, "sha256": "e36368b985a01940b39a0405f3ccd730cbcb998e0baed419850068a033eb9c4d", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 108506.66, "filetype": "unknown", "entropy": 5.107253551483154, "sha256": "e15de266900d2513c831f990f691b206e1504126161d0079ff9a00da1eb17790", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 126417.1, "filetype": "unknown", "entropy": 4.3993401527404785, "sha256": "8a98fd1f45083aef444ba3f89ef98704acc7bbc89a7da109411064ee46a74653", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 142071.2, "filetype": "unknown", "entropy": 3.5526931285858154, "sha256": "f1fa7329401130631a5d18218871662ca20fe5b3e11990ee9914bed82d346840", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 1325.58, "filetype": "PNG", "entropy": 7.983079433441162, "sha256": "a88ec496f3553001fe9fe6fb9ddaa26bd759fbb40a88287425b6cfd8cb9e44be", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 753655.25, "filetype": "unknown", "entropy": 4.048840522766113, "sha256": "6fe0e6426e227e32d97737ce0cde5218413f9d521b2c3345b9aa3b1340785adb", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 256245.23, "filetype": "unknown", "entropy": 4.663979530334473, "sha256": "4a3b2b327c38fc108b66e1fa1f59ea13fb49389f226a5aa66bee13a78cdd4350", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 175546.7, "filetype": "unknown", "entropy": 4.172390937805176, "sha256": "f176a9e85c3560d4ad1f57b19e7fac2c4a06766eae98611a8cb6e5d8d0a29585", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 27010.22, "filetype": "unknown", "entropy": 5.3350138664245605, "sha256": "f98ecf41bbb5988f6301bbadc3cc48e36250cf37fef8bd70774efa22db4e9010", "type": "RT_ICON"}, {"lang": "ENGLISH US", "chi2": 12598.38, "filetype": "ICO", "entropy": 3.069030523300171, "sha256": "7b99fd4a774412f5f85424eb830da0f643394c77d711cf7c321c4e0069b2c07f", "type": "RT_GROUP_ICON"}, {"lang": "ENGLISH US", "chi2": 71811.12, "filetype": "unknown", "entropy": 3.5105128288269043, "sha256": "2aff682b2092461d654e67b5263c7921c1394270827724fee84f89af1df084cb", "type": "RT_VERSION"}, {"lang": "ENGLISH US", "chi2": 10764.32, "filetype": "XML", "entropy": 5.075985431671143, "sha256": "c0b50e6a8ae9b6a085b0e3b03e0d34e9ed66d60a0969fa143021735f4a0d2284", "type": "RT_MANIFEST"}], "resource_langs": {"ENGLISH US": 16}, "resource_types": {"RT_ICON": 13, "RT_MANIFEST": 1, "RT_VERSION": 1, "RT_GROUP_ICON": 1}, "overlay": {"chi2": 12737657.0, "filetype": "DOS EXE", "entropy": 6.716299533843994, "offset": 345600, "md5": "629cf3c9c121f6f34af0d4b2a592c79e", "size": 1409568}, "sections": [{"name": ".text", "chi2": 2245476.25, "virtual_address": 4096, "entropy": 6.33, "raw_size": 230912, "flags": "rx", "virtual_size": 230612, "md5": "ca9c3a6477c32dc1ecb41cd117874437"}, {"name": ".data", "chi2": 372806.84, "virtual_address": 237568, "entropy": 2.51, "raw_size": 3072, "flags": "rw", "virtual_size": 5796, "md5": "b965f3d83955435b46689e595c8f8374"}, {"name": ".idata", "chi2": 169817.45, "virtual_address": 245760, "entropy": 5.45, "raw_size": 11264, "flags": "r", "virtual_size": 11236, "md5": "1ca7cce4c3d5c237fcea774edff54f5b"}, {"name": ".didat", "chi2": 112877.0, "virtual_address": 258048, "entropy": 0.6, "raw_size": 512, "flags": "rw", "virtual_size": 76, "md5": "16c4f8963385ac7e37fa0469c4e697b6"}, {"name": ".rsrc", "chi2": 862657.62, "virtual_address": 262144, "entropy": 7.05, "raw_size": 87040, "flags": "r", "virtual_size": 86704, "md5": "8e926720c0886fc37369b62ce3dbccc2"}, {"name": ".reloc", "chi2": 49896.39, "virtual_address": 352256, "entropy": 6.69, "raw_size": 11776, "flags": "r", "virtual_size": 11376, "md5": "2c563fb6cdef642847a265aa1a82c853"}], "compiler_product_versions": ["[IMP] VS2008 SP1 build 30729 count=114", "[---] Unmarked objects count=1402", "id: 0x103, version: 28900 count=8", "id: 0x105, version: 28900 count=39", "id: 0x101, version: 28900 count=5", "id: 0x10d, version: 28900 count=49", "id: 0xfd, version: 28900 count=1", "id: 0x104, version: 28900 count=20", "id: 0xff, version: 28900 count=1", "id: 0x102, version: 28900 count=1"], "rich_pe_header_hash": "f07f9658fcc83dd40f3be44f7a058920", "import_list": [{"library_name": "msvcp_win.dll", "imported_functions": ["?_Xbad_function_call@std@@YAXXZ", "?_Xlength_error@std@@YAXPBD@Z", "?_Xout_of_range@std@@YAXPBD@Z"]}, {"library_name": "api-ms-win-crt-runtime-l1-1-0.dll", "imported_functions": ["_c_exit", "_initterm", "_initterm_e", "_register_thread_local_exe_atexit_callback", "_set_error_mode"]}, {"library_name": "api-ms-win-crt-string-l1-1-0.dll", "imported_functions": ["memset", "wcsncmp"]}, {"library_name": "api-ms-win-crt-private-l1-1-0.dll", "imported_functions": ["__current_exception", "__current_exception_context", "__CxxFrameHandler3", "__std_terminate", "_CxxThrowException", "_except_handler4_common", "_o___p___argc", "_o___p___wargv", "_o___p__commode", "_o___std_exception_copy", "_o___std_exception_destroy", "_o___stdio_common_vsnprintf_s", "_o___stdio_common_vsnwprintf_s", "_o___stdio_common_vswprintf", "_o__callnewh", "_o__cexit", "_o__configthreadlocale", "_o__configure_wide_argv", "_o__controlfp_s", "_o__crt_atexit", "_o__errno", "_o__exit", "_o__get_initial_wide_environment", "_o__initialize_onexit_table", "_o__initialize_wide_environment", "_o__invalid_parameter_noinfo", "_o__invalid_parameter_noinfo_noreturn", "_o__itow", "_o__itow_s", "_o__purecall", "_o__recalloc", "_o__register_onexit_function", "_o__seh_filter_exe", "_o__set_app_type", "_o__set_fmode", "_o__set_new_mode", "_o__wcsicmp", "_o__wcsnicmp", "_o__wtoi", "_o__wtol", "_o_exit", "_o_free", "_o_iswspace", "_o_malloc", "_o_realloc", "_o_strerror", "_o_terminate", "_o_wcsncpy_s", "memcmp", "memcpy", "memmove", "wcschr"]}, {"library_name": "api-ms-win-eventing-provider-l1-1-0.dll", "imported_functions": ["EventActivityIdControl", "EventEnabled", "EventRegister", "EventSetInformation", "EventUnregister", "EventWriteTransfer"]}, {"library_name": "api-ms-win-security-base-l1-1-0.dll", "imported_functions": ["AddAccessAllowedAce", "AddAce", "AdjustTokenPrivileges", "CopySid", "CreateWellKnownSid", "DeleteAce", "EqualPrefixSid", "GetAce", "GetAclInformation", "GetLengthSid", "GetSecurityDescriptorLength", "GetSidLengthRequired", "GetSidSubAuthority", "GetTokenInformation", "ImpersonateLoggedOnUser", "InitializeAcl", "InitializeSecurityDescriptor", "InitializeSid", "IsValidSid", "MakeAbsoluteSD", "MakeSelfRelativeSD", "RevertToSelf", "SetSecurityDescriptorDacl", "SetSecurityDescriptorGroup", "SetSecurityDescriptorOwner", "SetSecurityDescriptorSacl"]}, {"library_name": "OLEAUT32.dll", "imported_functions": ["CreateErrorInfo", "GetErrorInfo", "SetErrorInfo", "SysAllocString", "SysFreeString", "SysStringLen", "VarUI4FromStr"]}, {"library_name": "api-ms-win-core-libraryloader-l1-2-0.dll", "imported_functions": ["FindResourceExW", "FreeLibrary", "GetModuleFileNameA", "GetModuleFileNameW", "GetModuleHandleA", "GetModuleHandleExA", "GetModuleHandleExW", "GetModuleHandleW", "GetProcAddress", "LoadLibraryExW", "LoadResource", "LoadStringW", "SizeofResource"]}, {"library_name": "api-ms-win-core-windowserrorreporting-l1-1-0.dll", "imported_functions": ["WerSetFlags"]}, {"library_name": "api-ms-win-core-errorhandling-l1-1-1.dll", "imported_functions": ["AddVectoredExceptionHandler", "RemoveVectoredExceptionHandler"]}, {"library_name": "api-ms-win-security-lsalookup-l2-1-0.dll", "imported_functions": ["LookupAccountNameW", "LookupAccountSidW", "LookupPrivilegeValueW"]}, {"library_name": "api-ms-win-core-com-l1-1-0.dll", "imported_functions": ["CLSIDFromProgID", "CLSIDFromString", "CoCreateFreeThreadedMarshaler", "CoCreateInstance", "CoDisconnectObject", "CoInitializeEx", "CoInitializeSecurity", "CoTaskMemAlloc", "CoTaskMemFree", "CoTaskMemRealloc", "CoUninitialize", "PropVariantClear", "PropVariantCopy", "StringFromCLSID"]}, {"library_name": "api-ms-win-core-synch-l1-2-0.dll", "imported_functions": ["InitOnceBeginInitialize", "InitOnceComplete", "InitOnceExecuteOnce", "Sleep"]}, {"library_name": "api-ms-win-core-registry-l1-1-0.dll", "imported_functions": ["RegCloseKey", "RegCreateKeyExW", "RegDeleteKeyExW", "RegDeleteValueW", "RegEnumKeyExW", "RegEnumValueW", "RegGetValueW", "RegOpenKeyExW", "RegQueryInfoKeyW", "RegQueryValueExW", "RegSetValueExW"]}, {"library_name": "api-ms-win-core-string-l1-1-0.dll", "imported_functions": ["CompareStringOrdinal", "CompareStringW", "MultiByteToWideChar", "WideCharToMultiByte"]}, {"library_name": "api-ms-win-core-localization-l1-2-0.dll", "imported_functions": ["FormatMessageW", "GetLocaleInfoEx", "GetLocaleInfoW", "GetSystemDefaultLCID", "LCMapStringW", "LocaleNameToLCID", "ResolveLocaleName"]}, {"library_name": "api-ms-win-core-synch-l1-1-0.dll", "imported_functions": ["AcquireSRWLockExclusive", "AcquireSRWLockShared", "CreateEventExW", "CreateEventW", "CreateMutexExW", "CreateSemaphoreExW", "CreateWaitableTimerExW", "DeleteCriticalSection", "EnterCriticalSection", "InitializeCriticalSection", "InitializeCriticalSectionAndSpinCount", "InitializeCriticalSectionEx", "InitializeSRWLock", "LeaveCriticalSection", "OpenEventW", "OpenSemaphoreW", "ReleaseMutex", "ReleaseSemaphore", "ReleaseSRWLockExclusive", "ReleaseSRWLockShared", "ResetEvent", "SetEvent", "SetWaitableTimerEx", "TryAcquireSRWLockExclusive", "WaitForSingleObject", "WaitForSingleObjectEx"]}, {"library_name": "api-ms-win-core-heap-l1-1-0.dll", "imported_functions": ["GetProcessHeap", "HeapAlloc", "HeapFree", "HeapSetInformation"]}, {"library_name": "api-ms-win-core-errorhandling-l1-1-0.dll", "imported_functions": ["GetLastError", "RaiseException", "SetErrorMode", "SetLastError", "SetUnhandledExceptionFilter", "UnhandledExceptionFilter"]}, {"library_name": "api-ms-win-core-rtlsupport-l1-1-0.dll", "imported_functions": ["RtlCaptureContext"]}, {"library_name": "api-ms-win-core-handle-l1-1-0.dll", "imported_functions": ["CloseHandle", "DuplicateHandle", "GetHandleInformation"]}, {"library_name": "api-ms-win-core-processthreads-l1-1-0.dll", "imported_functions": ["CreateThread", "GetCurrentProcess", "GetCurrentProcessId", "GetCurrentThread", "GetCurrentThreadId", "GetProcessTimes", "OpenProcessToken", "OpenThreadToken", "SetPriorityClass", "TerminateProcess"]}, {"library_name": "api-ms-win-core-processthreads-l1-1-3.dll", "imported_functions": ["SetProcessInformation", "SetThreadDescription"]}, {"library_name": "api-ms-win-security-sddl-l1-1-0.dll", "imported_functions": ["ConvertStringSecurityDescriptorToSecurityDescriptorW", "ConvertStringSidToSidW"]}, {"library_name": "api-ms-win-core-synch-l1-2-1.dll", "imported_functions": ["WaitForMultipleObjects"]}, {"library_name": "api-ms-win-core-threadpool-l1-2-0.dll", "imported_functions": ["CloseThreadpoolTimer", "CreateThreadpoolTimer", "SetThreadpoolTimer", "WaitForThreadpoolTimerCallbacks"]}, {"library_name": "api-ms-win-core-string-l2-1-0.dll", "imported_functions": ["CharNextW"]}, {"library_name": "api-ms-win-core-memory-l1-1-0.dll", "imported_functions": ["CreateFileMappingW", "MapViewOfFile", "OpenFileMappingW", "ReadProcessMemory", "UnmapViewOfFile", "WriteProcessMemory"]}, {"library_name": "api-ms-win-shell-namespace-l1-1-0.dll", "imported_functions": ["ILFree", "SHCreateItemFromIDList", "SHParseDisplayName"]}, {"library_name": "ntdll.dll", "imported_functions": ["NtClose", "NtCreateCrossVmEvent", "NtCreateFile", "NtCreateSection", "NtMapViewOfSection", "NtQueryInformationProcess", "RtlAppendUnicodeStringToString", "RtlAppendUnicodeToString", "RtlFreeUnicodeString", "RtlGetPersistedStateLocation", "RtlIsStateSeparationEnabled", "RtlNtStatusToDosError", "RtlQueryPackageClaims", "RtlReportException", "RtlStringFromGUIDEx"]}, {"library_name": "api-ms-win-core-processthreads-l1-1-1.dll", "imported_functions": ["GetThreadTimes", "IsProcessorFeaturePresent", "SetProcessMitigationPolicy"]}, {"library_name": "api-ms-win-core-debug-l1-1-0.dll", "imported_functions": ["DebugBreak", "IsDebuggerPresent", "OutputDebugStringW"]}, {"library_name": "api-ms-win-core-heap-l2-1-0.dll", "imported_functions": ["LocalAlloc", "LocalFree"]}, {"library_name": "api-ms-win-core-string-obsolete-l1-1-0.dll", "imported_functions": ["lstrcmpiW"]}, {"library_name": "api-ms-win-core-sysinfo-l1-1-0.dll", "imported_functions": ["GetSystemTimeAsFileTime", "GetTickCount", "GetVersionExW"]}, {"library_name": "api-ms-win-core-processenvironment-l1-1-0.dll", "imported_functions": ["ExpandEnvironmentStringsW", "SearchPathW"]}, {"library_name": "api-ms-win-core-localization-obsolete-l1-2-0.dll", "imported_functions": ["GetSystemDefaultUILanguage", "GetUserDefaultUILanguage"]}, {"library_name": "api-ms-win-core-profile-l1-1-0.dll", "imported_functions": ["QueryPerformanceCounter"]}, {"library_name": "api-ms-win-core-interlocked-l1-1-0.dll", "imported_functions": ["InitializeSListHead"]}, {"library_name": "SHCORE.dll", "imported_functions": ["Ord(107)"]}, {"library_name": "api-ms-win-core-apiquery-l1-1-0.dll", "imported_functions": ["ApiSetQueryApiSetPresence"]}, {"library_name": "api-ms-win-core-winrt-l1-1-0.dll", "imported_functions": ["RoGetActivationFactory"]}, {"library_name": "api-ms-win-core-winrt-string-l1-1-0.dll", "imported_functions": ["WindowsCreateStringReference", "WindowsDeleteString", "WindowsGetStringRawBuffer"]}, {"library_name": "api-ms-win-core-timezone-l1-1-0.dll", "imported_functions": ["FileTimeToSystemTime", "SystemTimeToTzSpecificLocalTime"]}, {"library_name": "api-ms-win-core-datetime-l1-1-0.dll", "imported_functions": ["GetTimeFormatW"]}, {"library_name": "api-ms-win-core-file-l1-1-0.dll", "imported_functions": ["CreateFileW", "DeleteFileW", "FlushFileBuffers", "GetFileSize", "GetFileTime", "LockFile", "ReadFile", "SetEndOfFile", "SetFilePointer", "UnlockFile", "WriteFile"]}, {"library_name": "api-ms-win-core-delayload-l1-1-1.dll", "imported_functions": ["ResolveDelayLoadedAPI"]}, {"library_name": "api-ms-win-core-delayload-l1-1-0.dll", "imported_functions": ["DelayLoadFailureHook"]}, {"library_name": "api-ms-win-core-localization-l1-2-2.dll", "imported_functions": ["LCIDToLocaleName"]}, {"library_name": "api-ms-win-core-libraryloader-l1-2-1.dll", "imported_functions": ["LoadLibraryW"]}]}, "type_tag": "peexe", "last_analysis_results": {"Bkav": {"method": "blacklist", "engine_name": "Bkav", "engine_version": "2.0.0.1", "engine_update": "20250305", "category": "undetected", "result": null}, "Lionic": {"method": "blacklist", "engine_name": "Lionic", "engine_version": "8.16", "engine_update": "20250305", "category": "malicious", "result": "Trojan.Win32.Lumma.1u!c"}, "AVG": {"method": "blacklist", "engine_name": "AVG", "engine_version": "23.9.8494.0", "engine_update": "20250305", "category": "malicious", "result": "Win32:Lumma-E [Drp]"}, "Elastic": {"method": "blacklist", "engine_name": "Elastic", "engine_version": "4.0.191", "engine_update": "20250227", "category": "undetected", "result": null}, "MicroWorld-eScan": {"method": "blacklist", "engine_name": "MicroWorld-eScan", "engine_version": "14.0.409.0", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "CTX": {"method": "blacklist", "engine_name": "CTX", "engine_version": "2024.8.29.1", "engine_update": "20250305", "category": "malicious", "result": "exe.trojan.lumma"}, "CAT-QuickHeal": {"method": "blacklist", "engine_name": "CAT-QuickHeal", "engine_version": "22.00", "engine_update": "20250304", "category": "malicious", "result": "cld.trojan.lummastealer"}, "Skyhigh": {"method": "blacklist", "engine_name": "Skyhigh", "engine_version": "v2021.2.0+4045", "engine_update": "20250305", "category": "undetected", "result": null}, "ALYac": {"method": "blacklist", "engine_name": "ALYac", "engine_version": "2.0.0.10", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "Malwarebytes": {"method": "blacklist", "engine_name": "Malwarebytes", "engine_version": "4.5.5.54", "engine_update": "20250305", "category": "malicious", "result": "Spyware.Lumma"}, "Zillya": {"method": "blacklist", "engine_name": "Zillya", "engine_version": "2.0.0.5312", "engine_update": "20250304", "category": "undetected", "result": null}, "Sangfor": {"method": "blacklist", "engine_name": "Sangfor", "engine_version": "2.22.3.0", "engine_update": "20250305", "category": "undetected", "result": null}, "K7AntiVirus": {"method": "blacklist", "engine_name": "K7AntiVirus", "engine_version": "12.221.55018", "engine_update": "20250305", "category": "undetected", "result": null}, "Alibaba": {"method": "blacklist", "engine_name": "Alibaba", "engine_version": "0.3.0.5", "engine_update": "20190527", "category": "undetected", "result": null}, "K7GW": {"method": "blacklist", "engine_name": "K7GW", "engine_version": "12.221.55019", "engine_update": "20250305", "category": "undetected", "result": null}, "CrowdStrike": {"method": "blacklist", "engine_name": "CrowdStrike", "engine_version": "1.0", "engine_update": "20231026", "category": "undetected", "result": null}, "Arcabit": {"method": "blacklist", "engine_name": "Arcabit", "engine_version": "2022.0.0.18", "engine_update": "20250305", "category": "malicious", "result": "Trojan.Generic.D4869D87"}, "huorong": {"method": "blacklist", "engine_name": "huorong", "engine_version": "c5592d6:c5592d6:3af4bc1:3af4bc1", "engine_update": "20250305", "category": "undetected", "result": null}, "Baidu": {"method": "blacklist", "engine_name": "Baidu", "engine_version": "1.0.0.2", "engine_update": "20190318", "category": "undetected", "result": null}, "VirIT": {"method": "blacklist", "engine_name": "VirIT", "engine_version": "9.5.904", "engine_update": "20250304", "category": "malicious", "result": "Trojan.Win32.LummaStlr.HVZ"}, "Symantec": {"method": "blacklist", "engine_name": "Symantec", "engine_version": "1.22.0.0", "engine_update": "20250305", "category": "malicious", "result": "Trojan.Gen.MBT"}, "tehtris": {"method": "blacklist", "engine_name": "tehtris", "engine_version": "v0.1.4", "engine_update": "20250305", "category": "undetected", "result": null}, "ESET-NOD32": {"method": "blacklist", "engine_name": "ESET-NOD32", "engine_version": "30818", "engine_update": "20250305", "category": "undetected", "result": null}, "Cynet": {"method": "blacklist", "engine_name": "Cynet", "engine_version": "4.0.3.4", "engine_update": "20250305", "category": "undetected", "result": null}, "APEX": {"method": "blacklist", "engine_name": "APEX", "engine_version": "6.630", "engine_update": "20250304", "category": "undetected", "result": null}, "Paloalto": {"method": "blacklist", "engine_name": "Paloalto", "engine_version": "0.9.0.1003", "engine_update": "20250305", "category": "malicious", "result": "generic.ml"}, "ClamAV": {"method": "blacklist", "engine_name": "ClamAV", "engine_version": "1.4.2.0", "engine_update": "20250305", "category": "undetected", "result": null}, "Kaspersky": {"method": "blacklist", "engine_name": "Kaspersky", "engine_version": "22.0.1.28", "engine_update": "20250305", "category": "undetected", "result": null}, "BitDefender": {"method": "blacklist", "engine_name": "BitDefender", "engine_version": "7.2", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "NANO-Antivirus": {"method": "blacklist", "engine_name": "NANO-Antivirus", "engine_version": "1.0.170.26436", "engine_update": "20250305", "category": "undetected", "result": null}, "SUPERAntiSpyware": {"method": "blacklist", "engine_name": "SUPERAntiSpyware", "engine_version": "5.6.0.1032", "engine_update": "20250305", "category": "undetected", "result": null}, "Avast": {"method": "blacklist", "engine_name": "Avast", "engine_version": "23.9.8494.0", "engine_update": "20250305", "category": "malicious", "result": "Win32:Lumma-E [Drp]"}, "Tencent": {"method": "blacklist", "engine_name": "Tencent", "engine_version": "1.0.0.1", "engine_update": "20250305", "category": "undetected", "result": null}, "Emsisoft": {"method": "blacklist", "engine_name": "Emsisoft", "engine_version": "2024.8.0.61147", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015 (B)"}, "F-Secure": {"method": "blacklist", "engine_name": "F-Secure", "engine_version": "18.10.1547.307", "engine_update": "20250305", "category": "malicious", "result": "Dropper.DR/AVI.Lumma.pudcs"}, "DrWeb": {"method": "blacklist", "engine_name": "DrWeb", "engine_version": "7.0.65.5230", "engine_update": "20250305", "category": "undetected", "result": null}, "VIPRE": {"method": "blacklist", "engine_name": "VIPRE", "engine_version": "6.0.0.35", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "TrendMicro": {"method": "blacklist", "engine_name": "TrendMicro", "engine_version": "11.0.0.1006", "engine_update": "20250305", "category": "undetected", "result": null}, "McAfeeD": {"method": "blacklist", "engine_name": "McAfeeD", "engine_version": "1.2.0.7977", "engine_update": "20250305", "category": "malicious", "result": "ti!B4F58A9C2F27"}, "Trapmine": {"method": "blacklist", "engine_name": "Trapmine", "engine_version": "4.0.4.0", "engine_update": "20250205", "category": "undetected", "result": null}, "CMC": {"method": "blacklist", "engine_name": "CMC", "engine_version": "2.4.2022.1", "engine_update": "20250304", "category": "undetected", "result": null}, "Sophos": {"method": "blacklist", "engine_name": "Sophos", "engine_version": "2.5.5.0", "engine_update": "20250305", "category": "malicious", "result": "Mal/Generic-S"}, "Ikarus": {"method": "blacklist", "engine_name": "Ikarus", "engine_version": "6.3.30.0", "engine_update": "20250305", "category": "undetected", "result": null}, "FireEye": {"method": "blacklist", "engine_name": "FireEye", "engine_version": "35.47.0.0", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "Jiangmin": {"method": "blacklist", "engine_name": "Jiangmin", "engine_version": "16.0.100", "engine_update": "20250304", "category": "undetected", "result": null}, "Webroot": {"method": "blacklist", "engine_name": "Webroot", "engine_version": "1.9.0.8", "engine_update": "20250227", "category": "undetected", "result": null}, "Varist": {"method": "blacklist", "engine_name": "Varist", "engine_version": "6.6.1.3", "engine_update": "20250305", "category": "malicious", "result": "W32/ABTrojan.RMQB-4475"}, "Avira": {"method": "blacklist", "engine_name": "Avira", "engine_version": "8.3.3.20", "engine_update": "20250305", "category": "malicious", "result": "DR/AVI.Lumma.pudcs"}, "Antiy-AVL": {"method": "blacklist", "engine_name": "Antiy-AVL", "engine_version": "3.0", "engine_update": "20250305", "category": "malicious", "result": "Trojan/Win32.LummaStealer"}, "Kingsoft": {"method": "blacklist", "engine_name": "Kingsoft", "engine_version": "None", "engine_update": "20250305", "category": "undetected", "result": null}, "Gridinsoft": {"method": "blacklist", "engine_name": "Gridinsoft", "engine_version": "1.0.210.174", "engine_update": "20250305", "category": "undetected", "result": null}, "Xcitium": {"method": "blacklist", "engine_name": "Xcitium", "engine_version": "37528", "engine_update": "20250305", "category": "malicious", "result": "ApplicUnwnt@#912klm6q1bke"}, "Microsoft": {"method": "blacklist", "engine_name": "Microsoft", "engine_version": "1.1.25010.7", "engine_update": "20250305", "category": "malicious", "result": "Trojan:Win32/LummaStealer!rfn"}, "ViRobot": {"method": "blacklist", "engine_name": "ViRobot", "engine_version": "2014.3.20.0", "engine_update": "20250305", "category": "undetected", "result": null}, "GData": {"method": "blacklist", "engine_name": "GData", "engine_version": "A:25.39896B:27.39491", "engine_update": "20250305", "category": "malicious", "result": "Trojan.GenericKD.75931015"}, "Google": {"method": "blacklist", "engine_name": "Google", "engine_version": "1741174271", "engine_update": "20250305", "category": "malicious", "result": "Detected"}, "AhnLab-V3": {"method": "blacklist", "engine_name": "AhnLab-V3", "engine_version": "3.27.1.10534", "engine_update": "20250305", "category": "malicious", "result": "Dropper/Win.Lumma.C5736262"}, "Acronis": {"method": "blacklist", "engine_name": "Acronis", "engine_version": "1.2.0.121", "engine_update": "20240328", "category": "undetected", "result": null}, "McAfee": {"method": "blacklist", "engine_name": "McAfee", "engine_version": "6.0.6.653", "engine_update": "20250305", "category": "malicious", "result": "Artemis!60DEB6A8466E"}, "TACHYON": {"method": "blacklist", "engine_name": "TACHYON", "engine_version": "2025-03-05.02", "engine_update": "20250305", "category": "undetected", "result": null}, "VBA32": {"method": "blacklist", "engine_name": "VBA32", "engine_version": "5.3.1", "engine_update": "20250305", "category": "undetected", "result": null}, "Cylance": {"method": "blacklist", "engine_name": "Cylance", "engine_version": "3.0.0.0", "engine_update": "20250109", "category": "malicious", "result": "Unsafe"}, "Panda": {"method": "blacklist", "engine_name": "Panda", "engine_version": "4.6.4.2", "engine_update": "20250304", "category": "malicious", "result": "Trj/Chgt.AD"}, "TrendMicro-HouseCall": {"method": "blacklist", "engine_name": "TrendMicro-HouseCall", "engine_version": "10.0.0.1040", "engine_update": "20250305", "category": "undetected", "result": null}, "Rising": {"method": "blacklist", "engine_name": "Rising", "engine_version": "25.0.0.28", "engine_update": "20250305", "category": "undetected", "result": null}, "Yandex": {"method": "blacklist", "engine_name": "Yandex", "engine_version": "5.5.2.24", "engine_update": "20250305", "category": "undetected", "result": null}, "SentinelOne": {"method": "blacklist", "engine_name": "SentinelOne", "engine_version": "25.1.1.1", "engine_update": "20250114", "category": "undetected", "result": null}, "MaxSecure": {"method": "blacklist", "engine_name": "MaxSecure", "engine_version": "1.0.0.1", "engine_update": "20250305", "category": "malicious", "result": "Trojan.Malware.327736878.susgen"}, "Fortinet": {"method": "blacklist", "engine_name": "Fortinet", "engine_version": "7.0.30.0", "engine_update": "20250305", "category": "undetected", "result": null}, "Zoner": {"method": "blacklist", "engine_name": "Zoner", "engine_version": "2.2.2.0", "engine_update": "20250305", "category": "undetected", "result": null}, "DeepInstinct": {"method": "blacklist", "engine_name": "DeepInstinct", "engine_version": "5.0.0.8", "engine_update": "20250227", "category": "malicious", "result": "MALICIOUS"}, "alibabacloud": {"method": "blacklist", "engine_name": "alibabacloud", "engine_version": "2.2.0", "engine_update": "20241030", "category": "malicious", "result": "Trojan[dropper]:Win/LummaStealer.Gen"}, "Avast-Mobile": {"method": "blacklist", "engine_name": "Avast-Mobile", "engine_version": "250305-04", "engine_update": "20250305", "category": "type-unsupported", "result": null}, "SymantecMobileInsight": {"method": "blacklist", "engine_name": "SymantecMobileInsight", "engine_version": "2.0", "engine_update": "20250124", "category": "type-unsupported", "result": null}, "BitDefenderFalx": {"method": "blacklist", "engine_name": "BitDefenderFalx", "engine_version": "2.0.936", "engine_update": "20241203", "category": "type-unsupported", "result": null}, "Trustlook": {"method": "blacklist", "engine_name": "Trustlook", "engine_version": "1.0", "engine_update": "20250305", "category": "type-unsupported", "result": null}}, "type_tags": ["executable", "windows", "win32", "pe", "peexe"], "magika": "PEBIN", "sandbox_verdicts": {"Zenbox": {"category": "malicious", "malware_classification": ["MALWARE", "TROJAN"], "sandbox_name": "Zenbox", "malware_names": ["Emmenhtal Loader"], "confidence": 56}, "Yomi Hunter": {"category": "malicious", "malware_classification": ["MALWARE"], "sandbox_name": "Yomi Hunter"}}, "times_submitted": 12, "last_analysis_stats": {"malicious": 33, "suspicious": 0, "undetected": 39, "harmless": 0, "timeout": 0, "confirmed-timeout": 0, "failure": 0, "type-unsupported": 4}, "size": 1755168}, "relationships": {"contacted_domains": {"data": [{"type": "domain", "id": "res.public.onecdn.static.microsoft"}, {"type": "domain", "id": "www.microsoft.com"}], "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/relationships/contacted_domains?limit=20", "related": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/contacted_domains"}}, "dropped_files": {"data": [], "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/relationships/dropped_files?limit=20", "related": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/dropped_files"}}, "contacted_urls": {"data": [], "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/relationships/contacted_urls?limit=20", "related": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/contacted_urls"}}, "bundled_files": {"data": [], "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/relationships/bundled_files?limit=20", "related": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/bundled_files"}}, "contacted_ips": {"data": [{"type": "ip_address", "id": "192.168.0.17"}, {"type": "ip_address", "id": "192.168.0.18"}, {"type": "ip_address", "id": "20.99.133.109"}, {"type": "ip_address", "id": "20.99.185.48"}, {"type": "ip_address", "id": "20.99.186.246"}, {"type": "ip_address", "id": "23.194.186.99"}, {"type": "ip_address", "id": "23.196.145.221"}, {"type": "ip_address", "id": "23.196.193.245"}, {"type": "ip_address", "id": "23.32.75.136"}, {"type": "ip_address", "id": "23.32.75.139"}, {"type": "ip_address", "id": "23.32.75.148"}, {"type": "ip_address", "id": "23.32.75.149"}, {"type": "ip_address", "id": "23.32.75.151"}, {"type": "ip_address", "id": "23.32.75.154"}, {"type": "ip_address", "id": "23.32.75.164"}, {"type": "ip_address", "id": "23.32.75.166"}, {"type": "ip_address", "id": "23.32.75.169"}, {"type": "ip_address", "id": "23.55.140.42"}], "links": {"self": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/relationships/contacted_ips?limit=20", "related": "https://www.virustotal.com/api/v3/files/b4f58a9c2f27210bd9f0e8acb291d24dbc45507258364b4cac8da9c2092f8cc9/contacted_ips"}}}}}'
                    },
                }

class searchInVirusTotalAction(actionInterface):
    """Search ip, domain, MD5, SHA1 and SHA256 with the Virus Total API. The configuration should be passed in the config file.

Two parameters could be passed :

- `Analysis fields` a list of objects to be returned depending of the type of observable searched. JSON scheme is described on [VT](https://docs.virustotal.com/reference/files), you can unset this parameter to retrieve the whole JSON,
- `Relationships` a list of relationships to query. For each observable results will be added under `$.data.<relationship_name>` key and thus specific fields of relationship could be retrievedwith `$.relationships.relationship_name.<path>` thanks to the `Analysis fields` parameter


A configuration is neeeded : 

```yaml
VirusTotal:
- api_key: <VT API Key>
```
    """    
    def __init__(self, parsers ={}, supportedType = {"ip","domain","md5","sha1","sha256"}, complex_param=DEFAULT_PARAMS):
        super().__init__(parsers = parsers, supportedType = supportedType, complex_param=complex_param)
        self.description = "Virus Total: Search all obsevables."
        self.indicators = "ðŸ”‘"
        self.lines = []
        self.load_conf("VirusTotal")
        API_KEY = self.conf.get("api-key","")
        self.headers = {"accept": "application/json", "x-apikey": API_KEY}

        
    def execute(self) -> object:
        self.observables = self.get_observables()
        self.results = {}
        
        relationships = ",".join(self.get_param_value("Relationships")) if self.get_param_value("Relationships") else ""
        for obs_type in self.supportedType:
            if obs_type=="ip" and (observables:=self.observables.get(obs_type,[])):
                for ip in observables:
                    url = f"https://www.virustotal.com/api/v3/ip_addresses/{ip}?relationships={relationships}"
                    try:
                        self.results[ip] = response.json()
                    except:
                        self.results[ip] = {}
            if obs_type=="domain" and (observables:=self.observables.get(obs_type,[])):
                for domain in observables:
                    url = f"https://www.virustotal.com/api/v3/domains/{domain}?relationships={relationships}"
                    try:
                        response = requests.get(url, headers=self.headers)
                        self.results[domain] = response.json()
                    except:
                        self.results[domain] = {}                   
            if obs_type in ["md5","sha1","sha256"] and (observables:=self.observables.get(obs_type,[])):
                for file_hash in observables:
                    url = f"https://www.virustotal.com/api/v3/files/{file_hash}?relationships={relationships}"
                    try:
                        response = requests.get(url, headers=self.headers)
                        self.results[file_hash] = response.json()
                    except:
                        self.results[file_hash] = {}
            if selectors := self.get_param_value("Analysis fields"):
                jq_query = []
                for selector in selectors:
                    selector_key = selector.replace('"',"")
                    selector_key = re.sub(r"^(\.data\.attributes\.|\.data\.relationships\.)","", selector_key)
                    if "[]" in selector_key:
                        jq_query.append(f'"{selector_key}":[{selector}]')
                    else:
                        jq_query.append(f'"{selector_key}":{selector}')
                jq_query = f"{{{",".join(jq_query)}}}"
                for observable, result in self.results.items():
                    try: 
                        query = jq.compile(jq_query)
                        self.results[observable] = query.input_value(result).all()
                    except:
                        self.results[observable] = {}

        return self.results
    
    def __str__(self):
        self.execute()
        text = []
        for k,v in self.results.items():
            text.append(f"{k}\t{json.dumps(v,indent=None)}")
        return "\n".join(text)

if __name__=='__main__':
    from userTypeParser.MD5Parser import md5Parser

    data = "127.0.0.1, 124.0.12.23, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa, test@domain.com"
    parser = md5Parser(data)
    a = str(searchInVirusTotalAction({"md5":parser},["md5"], complex_param=DEFAULT_PARAMS))